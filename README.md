# Характеристики протокола.

- **Тип поддерживаемого соединения:** клиент-сервер
- **Основной транспортный протокол:** UDP
- **Алгоритм шифрования:** AES
- **Режим шифрования:** GCM
- **Максимальный размер приема датаграмм:** 4096 байт
- **Гарантия доставки:** отсутствует
- **Политика потерь пакетов:** "Didn’t arrive = lost".  
  Опоздавшие пакеты отбрасываются, повторный приём невозможен.
- **Завершение соединения:** keep-alive (ack)   
   Автоматическое завершение мертвого соединения.

#### **Задачи протокола** - протокол предназначен для замены QUIC в задачах стриминга, видео- и голосовых звонках и передачи игровых данных. TSUP более прост и имеет минимальный оверхед, удобен для небольших проектов и легок в обслуживании.

&ensp;

**Проведены тесты с максимальным количеством пакетов в секунду по 1000 и 4000 байтов на локальной сети:** 

**1 КБ/пакет**

*TSUP: 22700 пакетов/сек. (181~ Мбит/сек)*

*UDP: 62300 пакетов/сек. (500~ Мбит/сек)*

*Потери TSUP за 10 секунд теста:* 66 пакетов из 227000 потеряно (0.028% потерь).

**4 КБ/пакет**

*TSUP: 19200 пакетов/сек. (615~ Мбит/сек)*

*UDP: 54500 пакетов/сек. (1.7~ Гбит/сек)*

*Потери TSUP за 10 секунд теста:* 64 пакетов из 192000 потеряно (0.034% потерь).

**64 КБ/пакет**

*TSUP: 5200 пакетов/сек. (2.7~ Гбит/сек)*

*UDP: 28200  пакетов/сек. (14.7~ Гбит/сек)*

*Потери TSUP за 10 секунд теста:* 10 пакетов из 52000 потеряно (0.019% потерь).

**На таком же железе и в одинаковом тесте протокол TSUP медленнее чистого UDP в 2.74 раза при 1 КБ/пакет. Тест упирается в производительность CPU (достигает 100%). Потери TSUP составляют 0.02-0.03%**



&ensp;
# Чертеж TSUP

| **Header**<br><br>(байты/флаги) | **Nonce**<br><br>(уникальный IV) | **Payload**<br><br>(основные данные) | **Auth Tag**<br><br>(подпись AEAD) |
| --- | --- | --- | --- |

&ensp;

| **Type**<br><br>1B | **Flags**<br><br>1B | **Seq**<br><br>2B | **Nonce**<br><br>12B | **Payload**<br><br>XB | **Auth Tag**<br><br>16B |
| --- | --- | --- | --- | --- | --- |

&ensp;

# Структура пакета


## 1\. HEADER (4 байта)

**Type (1 байт).**

| 1   | HANDSHAKE_INIT (client → server) | Подключение клиента к серверу. Отправка публичного ключа RSA. |
| --- | --- | --- |
| 2   | HANDSHAKE_ACK (server → client) | Ответ сервера клиенту на запрос подключения. Содержит AEAD ключ в случае принятия подключения. |
| 3   | DATA | Передача Payload. |
| 4   | ACK | Подтверждение о доставки пакетов согласно принципу Bitfield ACK. |
| 5   | _DISCONNECT_ | Отключение от соединения. |
| 6   | HEARTBEAT / PING | Попытка достучаться до сервера/клиента. |

&ensp;

## SEQ (2 байта).

Содержит уникальный номер пакета от -32768 до 32767.

Протокол использует вариант от 0 до 65535 переводя short в unsigned тип.

&ensp;

## FLAGS (1 байт)

| **Бит** | **Название** | **Значение** |
| --- | --- | --- |
| **0** | **_ACK_BITFIELD_** | **Пакет типа ACK bitfield.**<br><br>**ACK возвращается на каждый 8 принятый пакет.**<br><br>**Пример: _0x01110011 – ровно 1 байт, где 3,4 и 10 пакеты не были доставлены._** |
| **1** | **_ENCRYPTED_** | **Зашифрованный Payload** |
| **2** | **_RESEND_REQUEST_**    | **Повторный пакет.**    |

**Пример:**

Байт 0b00000011 имеет флаги ACKB и ENCRYPTED означающий, что данные зашифрованы и это ACK.

&ensp;

## 2\. Nonce и Auth Tag (28 байт)

28 байт зарезервированы для работы с протоколом AEAD.

&ensp;
# Протокол подключения.

## HANDSHAKE

HANDSHAKE состоит из 1 запроса и 1 ответа.

Пример HANDSHAKE_INIT запроса:

| **Поле** | **Значение** |
| --- | --- |
| **Type** | **HANDSHAKE_INIT** |
| **Flags** | **0** |
| **Seq** | **0** |
| **Nonce** | **0** |
| **Payload** | **Публичный RSA-ключ.** |

Пример HANDSHAKE_ACK ответа:

| **Поле** | **Значение** |
| --- | --- |
| **Type** | **HANDSHAKE_ACK** |
| **Flags** | **0b00000010 (зашифрован)** |
| **Seq** | **1** |
| **Nonce** | **присутствует** |
| **Payload** | **Зашифрованный AEAD ключ.** |

При HANDSHAKE клиент отправляет серверу публичный RSA ключ. Сервер создает AES ключ, шифрует его ключом RSA и отправляет обратно клиенту. HANDSHAKE закончен.

&ensp;
# Техническая часть.

**Взаимодействие с библиотекой осуществляется через сокеты TSUPSocket и TSUPServerSocket**

Создание сокетов похоже на TCP (Socket, ServerSocket), однако для запуска клиента или сервера запускаются методы startClient(serverIp, serverPort) или startServer(myPort).

- Для прослушивания клиент резервирует порт на 6060.

- Для отправки запросов используется sendMessage(message).

- Для получения ответов используется реализация лямбда-функции setOnMessageReceiver(message -> {}).

- Для закрытия соединения используется disconnect().

&ensp;

**DispatcherSocket**

Отвечает за прием любых UDP пакетов и перенаправляет их на цепочку фильтров.

Прием пакетов осуществляется на основе паттерна **Filter Chain:** каждый пакет проходит через соответствующий фильтр (AckFilter, DecryptFilter) и в конце попадает на конечный FinalFilter.

&ensp;

**TSUPConext**

Основная роль - отправка пакетов (sendAck, sendData, sendDisconnect).

&ensp;

**ACKMonitor**

На данный момент существует класс ACKMonitor проверяющий пакеты ack-bitfield. ACKMonitor - своего рода замена keep-alive системы пинговщика. В случае если на каждый отправленный 8 пакет какое то время не приходит ответный ack, то ACKMonitor считает соединение мертвым и закрывает его.

&ensp;

**Seq**

Каждый пакет имеет уникальный номер. Система проверки новизны пакетов работает по принципу "didn't arrive - lost". 
В случае если какой то пакет приходит раньше другого (например пакет с номером 20 пришел после пакета с номером 10, а затем пришли пакеты с номерами 11,12 и т.д), то старые пакеты считаются опоздавшими или потерянными и не принимаются (фильтр SyncFilter).

&ensp;

# Разработка.

Протокол все еще разрабатывается. Некоторые возможности вроде resend, ping все еще не реализованы и их реализация остается под вопросом. 
TSUP будет улучшаться и тестироваться дальше в том числе и на практических задачах. 

В будущем возможен выбор алгоритма шифрования (AES, ChaCha20), изменение максимального размера приема пакетов (вместо стандартного 512 байтов), переключение политики приема пакетов (опоздавшие или не пришедшие - потеряны; не пришедшие - resend) и другое.