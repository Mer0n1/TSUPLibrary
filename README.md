# Чертеж TSUP

| **Header**<br><br>(байты/флаги) | **Nonce**<br><br>(уникальный IV) | **Payload**<br><br>(основные данные) | **Auth Tag**<br><br>(подпись AEAD) |
| --- | --- | --- | --- |

&ensp;

| **Type**<br><br>1B | **Flags**<br><br>1B | **Seq**<br><br>2B | **Nonce**<br><br>12B | **Payload**<br><br>XB | **Auth Tag**<br><br>16B |
| --- | --- | --- | --- | --- | --- |

&ensp;

# Структура пакета


## 1\. HEADER (4 байта)

**Type (1 байт).**

| 1   | HANDSHAKE_INIT (client → server) | Подключение клиента к серверу. Отправка публичного ключа RSA. |
| --- | --- | --- |
| 2   | HANDSHAKE_ACK (server → client) | Ответ сервера клиенту на запрос подключения. Содержит AEAD ключ в случае принятия подключения. |
| 3   | DATA | Передача Payload. |
| 4   | ACK | Подтверждение о доставки пакетов согласно принципу Bitfield ACK. |
| 5   | _DISCONNECT_ | Отключение от соединения. |
| 6   | HEARTBEAT / PING | Попытка достучаться до сервера/клиента. |

&ensp;

## SEQ (2 байта).

Содержит уникальный номер пакета от -32768 до 32767.

Протокол использует вариант от 0 до 65535 переводя short в unsigned тип.

&ensp;

## FLAGS (1 байт)

| **Бит** | **Название** | **Значение** |
| --- | --- | --- |
| **0** | **_ACK_BITFIELD_** | **Пакет типа ACK bitfield.**<br><br>**ACK возвращается на каждый 8 принятый пакет.**<br><br>**Пример: _0x01110011 – ровно 1 байт, где 3,4 и 10 пакеты не были доставлены._** |
| **1** | **_ENCRYPTED_** | **Зашифрованный Payload** |
| **2** | **_RESEND_REQUEST_**    | **Повторный пакет.**    |

**Пример:**

Байт 0b00000011 имеет флаги ACKB и ENCRYPTED означающий, что данные зашифрованы и это ACK.

&ensp;

## 2\. Nonce и Auth Tag (28 байт)

28 байт зарезервированы для работы с протоколом AEAD.

&ensp;
# Протокол подключения и работы.

## HANDSHAKE

HANDSHAKE состоит из 1 запроса и 1 ответа.

Пример HANDSHAKE_INIT запроса:

| **Поле** | **Значение** |
| --- | --- |
| **Type** | **HANDSHAKE_INIT** |
| **Flags** | **0** |
| **Seq** | **0** |
| **Nonce** | **0** |
| **Payload** | **Публичный RSA-ключ.** |

Пример HANDSHAKE_ACK ответа:

| **Поле** | **Значение** |
| --- | --- |
| **Type** | **HANDSHAKE_ACK** |
| **Flags** | **0b00000010 (зашифрован)** |
| **Seq** | **1** |
| **Nonce** | **присутствует** |
| **Payload** | **Зашифрованный AEAD ключ.** |

При HANDSHAKE клиент отправляет серверу публичный RSA ключ. Сервер создает AEAD ключ, шифрует его ключом RSA и отправляет обратно клиенту. HANDSHAKE закончен.

&ensp;
# Техническая часть.

**Взаимодействие с библиотекой осуществляется через MyTSUPLibrary.**

Перед началом работы следует запустить startClient(serverIp) или startServer().

Порты зарезервированы на 6060.

Для отправки запросов используется sendMessage().

Для получения ответов используется реализация лямбда-функции setOnMessageReceiver(message -> {}).

&ensp;

**DispatcherSocket**

Отвечает за прием любых UDP пакетов и перенаправляет их на цепочку фильтров.

Прием пакетов осуществляется на основе паттерна **Filter Chain:** каждый пакет проходит через соответствующий фильтр (AckFilter, DecryptFilter) и в конце попадает на конечный FinalFilter